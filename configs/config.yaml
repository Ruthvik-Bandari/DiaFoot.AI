# DiaFootAI Configuration
# ========================
# This file contains all configurable parameters for the project.
# Modify values here instead of hardcoding in scripts.

# ============================================
# Project Information
# ============================================
project:
  name: "DiaFootAI"
  version: "0.1.0"
  description: "Diabetic Foot Wound Assessment System"
  author: "Ruthvik"

# ============================================
# Paths Configuration
# ============================================
paths:
  # Data paths
  data_root: "data"
  raw_data: "data/raw"
  processed_data: "data/processed"
  annotations: "data/annotations"
  external_data: "data/external"
  
  # Model paths
  models_root: "models"
  checkpoints: "models/checkpoints"
  exported_models: "models/exported"
  
  # Output paths
  outputs: "outputs"
  logs: "outputs/logs"
  visualizations: "outputs/visualizations"
  predictions: "outputs/predictions"

# ============================================
# Dataset Configuration
# ============================================
dataset:
  # Dataset name to use
  name: "dfuc2022"  # Options: dfuc2022, fuseg, medetec, custom
  
  # Data split ratios
  train_ratio: 0.7
  val_ratio: 0.15
  test_ratio: 0.15
  
  # Random seed for reproducibility
  seed: 42
  
  # Image settings
  image:
    # Input size for models
    input_size: 512  # Will be [512, 512]
    # Original images will be resized/padded to this
    max_size: 1024
    # Channels (3 for RGB)
    channels: 3
    # Normalization (ImageNet stats)
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]
  
  # Class definitions for tissue classification
  tissue_classes:
    - name: "background"
      id: 0
      color: [0, 0, 0]
    - name: "granulation"
      id: 1
      color: [255, 0, 0]      # Red - healthy healing tissue
    - name: "slough"
      id: 2
      color: [255, 255, 0]    # Yellow - needs debridement
    - name: "necrotic"
      id: 3
      color: [0, 0, 0]        # Black - dead tissue
    - name: "epithelial"
      id: 4
      color: [255, 192, 203]  # Pink - new skin forming
    - name: "periwound"
      id: 5
      color: [255, 165, 0]    # Orange - surrounding skin
  
  # Wound classification (DFUC style)
  wound_classes:
    - name: "none"
      id: 0
    - name: "infection"
      id: 1
    - name: "ischaemia"
      id: 2
    - name: "both"
      id: 3

# ============================================
# Data Augmentation Configuration
# ============================================
augmentation:
  # Training augmentation
  train:
    enabled: true
    
    # Geometric transforms
    geometric:
      random_rotate_90:
        enabled: true
        p: 0.5
      horizontal_flip:
        enabled: true
        p: 0.5
      vertical_flip:
        enabled: true
        p: 0.3
      shift_scale_rotate:
        enabled: true
        shift_limit: 0.1
        scale_limit: 0.2
        rotate_limit: 30
        p: 0.7
      elastic_transform:
        enabled: true
        alpha: 120
        sigma: 6
        p: 0.3
      grid_distortion:
        enabled: true
        p: 0.2
    
    # Color transforms (critical for skin tone diversity)
    color:
      brightness_contrast:
        enabled: true
        brightness_limit: 0.3
        contrast_limit: 0.3
        p: 0.5
      hue_saturation:
        enabled: true
        hue_shift_limit: 20
        sat_shift_limit: 30
        val_shift_limit: 20
        p: 0.5
      random_gamma:
        enabled: true
        gamma_limit: [80, 120]
        p: 0.4
      clahe:
        enabled: true
        clip_limit: 4.0
        p: 0.3
    
    # Noise and quality simulation
    noise:
      gauss_noise:
        enabled: true
        var_limit: [10, 50]
        p: 0.3
      iso_noise:
        enabled: true
        p: 0.2
      motion_blur:
        enabled: true
        blur_limit: 3
        p: 0.2
      image_compression:
        enabled: true
        quality_lower: 70
        p: 0.3
    
    # Cutout / dropout
    cutout:
      enabled: true
      num_holes: 8
      max_h_size: 32
      max_w_size: 32
      p: 0.3
  
  # Validation augmentation (minimal)
  val:
    enabled: false
  
  # Test time augmentation
  tta:
    enabled: true
    transforms: ["original", "hflip", "vflip", "rotate90"]

# ============================================
# Model Configuration
# ============================================
models:
  # 1. Image Quality Assessment Model
  quality_checker:
    architecture: "mobilenet_v3_small"
    pretrained: true
    num_classes: 4  # acceptable, blur, lighting, angle
    input_size: 224
    dropout: 0.2
  
  # 2. Wound Segmentation Model
  segmentation:
    architecture: "unetplusplus"
    encoder: "efficientnet-b4"
    encoder_weights: "imagenet"
    in_channels: 3
    num_classes: 1  # Binary segmentation
    activation: "sigmoid"
    input_size: 512
    
    # Alternative architectures to experiment
    alternatives:
      - architecture: "deeplabv3plus"
        encoder: "resnet101"
      - architecture: "unet"
        encoder: "efficientnet-b3"
  
  # 3. Tissue Classification Model
  tissue_classifier:
    architecture: "efficientnet_b3"
    pretrained: true
    num_classes: 6  # background + 5 tissue types
    input_size: 256
    
    # Ensemble configuration
    ensemble:
      enabled: true
      models:
        - architecture: "efficientnet_b3"
          weight: 0.4
        - architecture: "vit_small_patch16_224"
          weight: 0.3
        - architecture: "resnet50"
          weight: 0.3
  
  # 4. Infection Detection Model
  infection_detector:
    architecture: "resnet50"
    pretrained: true
    num_classes: 2  # infected, not infected
    input_size: 384
    attention: true
    attention_type: "cbam"  # Channel and Spatial Attention

# ============================================
# Training Configuration
# ============================================
training:
  # General settings
  seed: 42
  deterministic: true
  
  # Hardware
  device: "mps"  # Options: cuda, mps (Apple Silicon), cpu
  num_workers: 4
  pin_memory: true
  
  # Batch size
  batch_size: 8
  accumulation_steps: 2  # Effective batch = 16
  
  # Epochs
  epochs: 150
  
  # Early stopping
  early_stopping:
    enabled: true
    patience: 20
    min_delta: 0.001
    monitor: "val_loss"
    mode: "min"
  
  # Optimizer
  optimizer:
    name: "adamw"
    lr: 1.0e-4
    weight_decay: 1.0e-4
    betas: [0.9, 0.999]
  
  # Learning rate scheduler
  scheduler:
    name: "cosine_annealing_warm_restarts"
    T_0: 10
    T_mult: 2
    eta_min: 1.0e-7
  
  # Loss functions
  loss:
    segmentation:
      name: "dice_bce"
      dice_weight: 0.5
      bce_weight: 0.5
    classification:
      name: "cross_entropy"
      label_smoothing: 0.1
    infection:
      name: "focal"
      alpha: 0.75
      gamma: 2.0
  
  # Mixed precision training
  mixed_precision:
    enabled: true
    dtype: "float16"
  
  # Gradient clipping
  gradient_clip:
    enabled: true
    max_norm: 1.0
  
  # Checkpointing
  checkpoint:
    save_best: true
    save_last: true
    save_every_n_epochs: 10
    monitor: "val_iou"
    mode: "max"

# ============================================
# Evaluation Configuration
# ============================================
evaluation:
  # Metrics for segmentation
  segmentation_metrics:
    - "iou"
    - "dice"
    - "precision"
    - "recall"
    - "f1"
    - "hausdorff_distance"
  
  # Metrics for classification
  classification_metrics:
    - "accuracy"
    - "precision"
    - "recall"
    - "f1"
    - "auc_roc"
    - "confusion_matrix"
  
  # Thresholds
  thresholds:
    segmentation: 0.5
    infection: 0.5
  
  # Visualization
  visualize:
    enabled: true
    num_samples: 20
    save_predictions: true

# ============================================
# Inference Configuration
# ============================================
inference:
  # Model to use (path or name)
  model_path: "models/exported/segmentation_best.pt"
  
  # Batch size for inference
  batch_size: 1
  
  # Test time augmentation
  tta_enabled: false
  
  # Confidence threshold
  confidence_threshold: 0.5
  
  # Post-processing
  postprocess:
    # Remove small connected components
    remove_small_objects:
      enabled: true
      min_size: 100  # pixels
    # Fill holes in segmentation
    fill_holes:
      enabled: true
    # Smooth boundaries
    smooth_boundaries:
      enabled: true
      kernel_size: 5

# ============================================
# Export Configuration (Mobile Deployment)
# ============================================
export:
  # Export formats
  formats:
    - "pytorch"
    - "onnx"
    - "tflite"
    - "coreml"
  
  # Quantization
  quantization:
    enabled: true
    type: "dynamic"  # Options: dynamic, static, qat
    dtype: "int8"
  
  # Optimization
  optimize:
    enabled: true
    fuse_layers: true
    optimize_for_mobile: true
  
  # Target specifications
  targets:
    android:
      min_sdk: 24
      target_sdk: 33
    ios:
      min_version: "14.0"

# ============================================
# Logging Configuration
# ============================================
logging:
  # Log level
  level: "INFO"
  
  # Console logging
  console:
    enabled: true
    format: "rich"  # Options: simple, rich
  
  # File logging
  file:
    enabled: true
    path: "outputs/logs"
    rotation: "10 MB"
    retention: "30 days"
  
  # Weights & Biases
  wandb:
    enabled: true
    project: "diafootai"
    entity: null  # Your W&B username
    tags: ["wound-segmentation", "diabetic-foot"]
    log_model: true
    log_code: true

# ============================================
# Experiment Tracking
# ============================================
experiment:
  # Experiment name (auto-generated if null)
  name: null
  
  # Tags for filtering
  tags: []
  
  # Notes
  notes: ""
  
  # Track code version
  track_git: true
